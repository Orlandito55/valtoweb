{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///D:/PROYECTOS%20FLUTTER/valtoweb/app/api/tipo-cambio/route.ts"],"sourcesContent":["import { NextResponse } from 'next/server';\r\n\r\nexport async function GET(request: Request) {\r\n  try {\r\n    const { searchParams } = new URL(request.url);\r\n    const period = searchParams.get('period') || '1M';\r\n    \r\n    let currentRate = 3.37; // Valor por defecto actualizado\r\n    let historicalRates: any[] = [];\r\n    \r\n    try {\r\n      // Usar ExchangeRate-API y ajustar al mercado peruano\r\n      const response = await fetch(\r\n        'https://open.er-api.com/v6/latest/USD',\r\n        {\r\n          headers: {\r\n            'Accept': 'application/json',\r\n          },\r\n          cache: 'no-store'\r\n        }\r\n      );\r\n      \r\n      if (response.ok) {\r\n        const data = await response.json();\r\n        if (data && data.rates && data.rates.PEN) {\r\n          // Ajuste para aproximarse más al mercado comercial peruano\r\n          // La tasa interbancaria suele ser ligeramente mayor, ajustamos -0.5%\r\n          const interbankRate = data.rates.PEN;\r\n          currentRate = parseFloat((interbankRate * 0.995).toFixed(3)); // Ajuste al mercado comercial\r\n          \r\n          console.log('✅ Tasa interbancaria:', interbankRate, '→ Tasa comercial ajustada:', currentRate);\r\n          \r\n          // Obtener fecha de última actualización\r\n          const lastUpdate = data.time_last_update_unix \r\n            ? new Date(data.time_last_update_unix * 1000).toISOString()\r\n            : new Date().toISOString();\r\n          \r\n          // Generar datos históricos realistas basados en el valor actual real\r\n          const endDate = new Date();\r\n          const startDate = new Date();\r\n          \r\n          switch(period) {\r\n            case '1D':\r\n              startDate.setDate(endDate.getDate() - 1);\r\n              break;\r\n            case '1W':\r\n              startDate.setDate(endDate.getDate() - 7);\r\n              break;\r\n            case '1M':\r\n              startDate.setMonth(endDate.getMonth() - 1);\r\n              break;\r\n            case '3M':\r\n              startDate.setMonth(endDate.getMonth() - 3);\r\n              break;\r\n            case '6M':\r\n              startDate.setMonth(endDate.getMonth() - 6);\r\n              break;\r\n            case '1Y':\r\n              startDate.setFullYear(endDate.getFullYear() - 1);\r\n              break;\r\n            default:\r\n              startDate.setMonth(endDate.getMonth() - 1);\r\n          }\r\n          \r\n          // Generar histórico con variación realista del mercado\r\n          historicalRates = generateRealisticHistoricalData(currentRate, startDate, endDate);\r\n          \r\n          return NextResponse.json(historicalRates);\r\n        }\r\n      }\r\n    } catch (error) {\r\n      console.error('Error con ExchangeRate-API:', error);\r\n    }\r\n    \r\n    // Fallback en caso de error\r\n    console.error('No se pudieron obtener datos, usando fallback');\r\n    const endDate = new Date();\r\n    const startDate = new Date();\r\n    startDate.setMonth(endDate.getMonth() - 1);\r\n    \r\n    return NextResponse.json(generateRealisticHistoricalData(currentRate, startDate, endDate));\r\n    \r\n  } catch (error) {\r\n    console.error('Error crítico en API:', error);\r\n    \r\n    const endDate = new Date();\r\n    const startDate = new Date();\r\n    startDate.setMonth(endDate.getMonth() - 1);\r\n    \r\n    return NextResponse.json(generateRealisticHistoricalData(3.37, startDate, endDate), { status: 200 });\r\n  }\r\n}\r\n\r\n// Generar datos históricos realistas con variación de mercado\r\nfunction generateRealisticHistoricalData(currentRate: number, startDate: Date, endDate: Date) {\r\n  const data = [];\r\n  const currentDateObj = new Date(startDate);\r\n  const totalDays = Math.floor((endDate.getTime() - startDate.getTime()) / (1000 * 60 * 60 * 24));\r\n  \r\n  // Spread fijo realista de casas de cambio peruanas\r\n  const spread = 0.02; // 2 centavos de diferencia entre compra/venta\r\n  \r\n  // Variación máxima diaria realista del mercado forex (±0.5%)\r\n  const maxDailyVariation = 0.005;\r\n  \r\n  let rate = currentRate * 0.99; // Empezar un poco más bajo que el actual\r\n  let dayIndex = 0;\r\n  \r\n  while (currentDateObj <= endDate) {\r\n    // Tendencia gradual hacia el valor actual con variación diaria realista\r\n    const targetProgress = dayIndex / totalDays;\r\n    const targetRate = rate + (currentRate - rate) * 0.1; // Ajuste gradual hacia actual\r\n    \r\n    // Añadir variación diaria realista del mercado\r\n    const dailyChange = (Math.random() - 0.5) * 2 * maxDailyVariation * currentRate;\r\n    rate = targetRate + dailyChange;\r\n    \r\n    // Asegurar que no se desvíe mucho del valor actual\r\n    const minRate = currentRate * 0.97;\r\n    const maxRate = currentRate * 1.01;\r\n    rate = Math.max(minRate, Math.min(maxRate, rate));\r\n    \r\n    data.push({\r\n      compra: parseFloat((rate - spread).toFixed(3)),\r\n      venta: parseFloat((rate + spread).toFixed(3)),\r\n      fecha: currentDateObj.toISOString().split('T')[0]\r\n    });\r\n    \r\n    currentDateObj.setDate(currentDateObj.getDate() + 1);\r\n    dayIndex++;\r\n  }\r\n  \r\n  // Asegurar que el último valor sea el actual\r\n  if (data.length > 0) {\r\n    data[data.length - 1] = {\r\n      compra: parseFloat((currentRate - spread).toFixed(3)),\r\n      venta: parseFloat((currentRate + spread).toFixed(3)),\r\n      fecha: new Date().toISOString()\r\n    };\r\n  }\r\n  \r\n  return data;\r\n}\r\n"],"names":[],"mappings":"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"}}]
}